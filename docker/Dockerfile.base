FROM python:3.11-slim

# 设置代理环境变量
ARG http_proxy
ARG https_proxy
ARG all_proxy

# 设置时区
ENV TZ=Asia/Shanghai
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# 修复软件源和GPG密钥问题 - 使用更彻底的方法
RUN echo 'Acquire::Check-Valid-Until "false";' > /etc/apt/apt.conf.d/99no-check-valid && \
    echo 'APT::Get::AllowUnauthenticated "true";' >> /etc/apt/apt.conf.d/99no-check-valid && \
    echo 'Acquire::AllowInsecureRepositories "true";' >> /etc/apt/apt.conf.d/99no-check-valid && \
    echo 'Acquire::AllowDowngradeToInsecureRepositories "true";' >> /etc/apt/apt.conf.d/99no-check-valid

# 清理并重新配置软件源
RUN rm -rf /var/lib/apt/lists/* /etc/apt/sources.list.d/* && \
    echo "deb http://deb.debian.org/debian bookworm main" > /etc/apt/sources.list && \
    echo "deb http://deb.debian.org/debian bookworm-updates main" >> /etc/apt/sources.list && \
    echo "deb http://security.debian.org/debian-security bookworm-security main" >> /etc/apt/sources.list


# 安装系统依赖
RUN apt-get update && apt-get install -y \
    wget \
    gnupg \
    fonts-ipafont-gothic fonts-wqy-zenhei fonts-thai-tlwg fonts-kacst fonts-freefont-ttf libxss1 \
    libglib2.0-0 \
    libnspr4 \
    libnss3 \
    libdbus-1-3 \
    libatk1.0-0 \
    libatspi2.0-0 \
    libxcomposite1 \
    libxdamage1 \
    libxfixes3 \
    libxrandr2 \
    libgbm1 \
    libxkbcommon0 \
    libasound2 \
    xvfb \
    # 添加缺少的依赖
    libx11-6 \
    libxcursor1 \
    libxi6 \
    libxtst6 \
    libcups2 \
    libdrm2 \
    libgtk-3-0 \
    libpango-1.0-0 \
    libcairo2 \
    libgdk-pixbuf2.0-0 \
    --no-install-recommends \
    && rm -rf /var/lib/apt/lists/*

# 创建非root用户
RUN groupadd -r playwright && useradd -r -g playwright -G audio,video playwright \
    && mkdir -p /home/playwright/Downloads \
    && mkdir -p /home/playwright/.cache \
    && chown -R playwright:playwright /home/playwright

# 安装Playwright
RUN pip install playwright

# 安装Playwright浏览器（以root用户身份）
RUN playwright install chromium
RUN playwright install
RUN chown -R playwright:playwright /home/playwright/.cache/ms-playwright



# 设置Playwright环境变量
ENV PLAYWRIGHT_BROWSERS_PATH=/home/playwright/.cache/ms-playwright
ENV DISPLAY=:99

# 确保浏览器文件权限正确 - 先检查目录是否存在
RUN ls -la /home/playwright/.cache/ || echo "Cache directory not found" && \
    ls -la /home/playwright/.cache/ms-playwright/ || echo "Playwright directory not found" && \
    chown -R playwright:playwright /home/playwright/.cache/ms-playwright || echo "Permission setting failed"

# 验证浏览器安装
RUN ls -la /home/playwright/.cache/ms-playwright/ || echo "Browser directory not found"

# 切换到playwright用户
USER playwright

# 验证浏览器在playwright用户下是否可用
RUN playwright --version

# 设置工作目录
WORKDIR /app

# 标记为基础镜像
LABEL description="AutoTest Base Image with Python, Playwright and all dependencies" 