FROM node:18-alpine

# 设置代理环境变量
ARG http_proxy
ARG https_proxy
ARG all_proxy


# 设置时区
ENV TZ=Asia/Shanghai
RUN apk add --no-cache tzdata && cp /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

WORKDIR /app

# 复制package文件
COPY frontend/package*.json ./

# 安装依赖
RUN npm ci

# 复制源代码
COPY frontend/ ./

# 构建应用（不设置VITE_API_BASE_URL，使用默认值）
RUN npm run build

# 安装serve
RUN npm install -g serve

RUN unset https_proxy http_proxy all_proxy HTTPS_PROXY HTTP_PROXY

# 验证代理已被移除
RUN env | grep -i proxy || echo "No proxy variables found"

# 暴露端口
EXPOSE 3000

# 启动命令：动态生成配置文件并启动服务
CMD ["sh", "-c", "echo \"window.__APP_CONFIG__ = { API_BASE_URL: '${VITE_API_BASE_URL:-/api}' };\" > /app/dist/config.js && exec serve -s dist -l 3000"] 