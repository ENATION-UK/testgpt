FROM autotest-base:latest 

# 创建数据目录并设置权限
RUN mkdir -p /app/data && chown -R playwright:playwright /app/data

# 修复 Playwright 浏览器权限问题
USER root
RUN playwright install chromium
RUN playwright install
RUN chown -R playwright:playwright /home/playwright/.cache/ms-playwright

# 切换回 playwright 用户
USER playwright

# 复制依赖文件
COPY pyproject.toml uv.lock ./

# 安装Python依赖
RUN pip install --no-cache-dir -e .

# 复制应用代码
COPY . .

RUN unset https_proxy http_proxy all_proxy HTTPS_PROXY HTTP_PROXY

# 验证代理已被移除
RUN env | grep -i proxy || echo "No proxy variables found"

# 暴露端口
EXPOSE 8000

# 启动命令 - 使用bash直接执行
CMD ["bash", "-c", "Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 & sleep 2 && python run.py"] 